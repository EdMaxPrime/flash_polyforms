{% extends "base.html" %}
{% block title %} Edit Form | Polyforms {% endblock %}
{% block body %}
    <h1 class="mt-5 mb-2">{{ form.title }}</h1>
    <nav class="nav nav-tabs mb-5">
        <a class="nav-item nav-link" href="/form/view?id={{form.id}}">Results</a>
        <a class="nav-item nav-link active" href="/form/edit?id={{form.id}}">Edit Form</a>
        <a class="nav-item nav-link" href="/form/info?id={{form.id}}">Share</a>
    </nav>
    {% set messages = get_flashed_messages() %}
    {% for m in messages %}
    <div class="alert alert-info">{{ m }}</div>
    {% endfor %}
    <form method="POST">
        <fieldset class="mb-5 polyforms-fieldset">
            <legend class="px-3 polyforms-legend">Basic Info</legend>
            <div class="form-group row">
                <label for="title" class="col-sm-2 col-form-label">Form Title: </label>
                <div class="col">
                    <input type="text" name="title" class="form-control" value="{{ form.title }}">
                </div>
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" name="login_required" id="login_required" class="form-check-input" {{"checked" if form.login_required}}>
                    <label for="login_required" class="form-check-label">Check this box to only let respondents fill out this form once. Note that this will require them to make accounts on this website and be logged in to fill out the form.</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" name="public_results" id="public_results" class="form-check-input" {{"checked" if form.public_results}}>
                    <label for="public_results" class="form-check-label">Check this box to let the results to this form be viewable by anyone with the link to the form. Otherwise, only you will be able to see the responses to this form.</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" name="open" id="open" class="form-check-input" {{"checked" if form.open}}>
                    <label for="open" class="form-check-label">Check this box to continue letting people respond to this form.</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="theme">Choose a theme. This affects how your form will look like.</label> 
                <select id="theme" name="theme">
                    {% for t in themes %}
                    <option value="{{t.name}}" {{"selected" if form.theme == t.name}}>{{t.display_name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="message">Write a message for users to see after they submit the form. To show a link back to the form, write <code>[AGAIN]</code>. To show a link to the results page, write <code>[RESULTS]</code>. To show the number of responses, write <code>[HOWMANY]</code>. To include your signature, write <code>[SIGNATURE]</code>.</label>
                <textarea id="message" rows="4" name="message" class="form-control" required>{{ form.message }}</textarea>
            </div>
            <input name="form_id" value="{{form.id}}" type="hidden">
            <input name="num_questions" value="{{form.questions|length}}" type="hidden">
        </fieldset>
        
        <h2>Questions</h2>
        <ol id="questionList">
            {% for q in form.questions %}
            {% if q.type == "short" %} {% set typeLabel = "one-line response" %} {% set minmax = "answer length" %}
            {% elif q.type == "long" %} {% set typeLabel = "extended response" %} {% set minmax = "answer length" %}
            {% elif q.type == "int" %} {% set typeLabel = "integer" %} {% set minmax = "value" %}
            {% elif q.type == "number" %} {% set typeLabel = "any number" %} {% set minmax = "value" %}
            {% elif q.type == "choice" %} {% set typeLabel = "multiple-choice" %} {% set minmax = "selected choices" %}
            {% endif %}
            <li>
                <div class="card mb-5">
                    <div class="card-header">
                        <a class="card-link" href="">Move Up</a>
                        <a class="card-link" href="">Move Down</a>
                        <a class="card-link" href="" id="{{q.index}}.deleteButton">Delete</a>
                        <p class="card-text text-danger d-none" id="{{q.index}}.deleteWarning">This question and its responses will be permanently deleted when you save.</p>
                    </div>
                    <div class="card-body">
                        <div class="form-group row">
                            <label for="{{q.index}}.question" class="polyforms-label col-12 col-sm-2 col-form-label">Question: </label>
                            <div class="col"><input id="{{q.index}}.question" name="{{q.index}}.question" type="text" value="{{q.question}}" class="form-control" required></div>
                        </div>
                        <div class="row">
                            <div class="form-group col-12 col-sm-6">
                                <label for="{{q.index}}.type" class="polyforms-label">Question Type: </label>
                                <select id="{{q.index}}.type" name="{{q.index}}.type" class="form-control" onchange="changeType({{q.index}}, this.value);">
                                    <option value="short" {{"selected" if q.type == "short"}}>one-line response</option>
                                    <option value="long" {{"selected" if q.type == "long"}}>extended response</option>
                                    <option value="int" {{"selected" if q.type == "int"}}>integer</option>
                                    <option value="number" {{"selected" if q.type == "number"}}>number</option>
                                    <option value="choice" {{"selected" if q.type == "choice"}}>multiple-choice</option>
                                </select>
                            </div>
                            <div class="form-group col">
                                <label for="{{q.index}}.required">Required:</label>
                                <input id="{{q.index}}.required" name="{{q.index}}.required" type="checkbox" {{"checked" if q.required}}>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col"><label for="{{q.index}}.min">Minimum {{minmax}}</label><input id="{{q.index}}.min" name="{{q.index}}.min" type="number" min="0" value="{{q.min}}" class="form-control" placeholder="number"></div>
                            <div class="col"><label for="{{q.index}}.max">Maximum {{minmax}}</label><input id="{{q.index}}.max" name="{{q.index}}.max" type="number" min="0" value="{{q.max}}" class="form-control" placeholder="number"></div>
                        </div>
                        <div class="form-group {{'polyforms-hidden' if q.type != 'choice'}}" id="{{q.index}}.answersDiv">
                            <label for="{{q.index}}.answers">Enter answer choices in the following box, where each answer choice is on a new line.</label>
                            <textarea name="{{q.index}}.answers" id="{{q.index}}.answers" class="form-control" rows="4" required>{% if "choices" in q %}{% for c in q.choices %}{{c.value+")" if c.value != c.text}}{{c.text}}{{"\n" if not loop.last}}{% endfor %}{% else %}.{% endif %}</textarea>
                        </div>
                        <input type="hidden" name="{{q.index}}.newIndex" value="{{q.index}}">
                        <input type="hidden" name="{{q.index}}.delete" id="{{q.index}}.delete" value="">
                    </div>
                </div>
            </li>
            {% endfor %}
        </ol>
        <div class="text-center mb-5"><a class="btn btn-primary" href="#" id="add">Add Question</a></div>
        <p>Make sure you save your changes before doing anything else</p>
        <input class="btn btn-success" type="submit" value="Save Changes">
        <a class="btn btn-danger" href="/form/toggle?id={{form.id}}&amp;setting=delete">Delete This Form</a>
    </form>
    <br><br><br><br>
    <script type="text/javascript" src="/static/js/utils.js"></script>
    <script type="text/javascript">
        var time = new Date();
        var alerts = document.getElementsByClassName("alert-info");
        var id;

        for(var i = 0; i < alerts.length; i++) {
            if(alerts[i].innerHTML == "Your changes have been saved") {
                var a = alerts[i];
                a.innerHTML = "Your changes have been saved " + elapsed(Date.now() - time.getTime()) + " <u>Dismiss</u>"
                id = setInterval(function () {
                    a.innerHTML = "Your changes have been saved " + elapsed(Date.now() - time.getTime()) + " <u>Dismiss</u>";
                }, 60000);
                a.addEventListener("click", function (event) {
                    clearInterval(id);
                    a.parentNode.removeChild(a);
                });
            }
        }

        var listElements = document.getElementsByTagName("li");
        var swapElements = function(before, after) {
            var beforeIndex = getChild(before, function(element) {
                var n = element.getAttribute("name");
                return (typeof n == "string") && n.indexOf(".newIndex") != -1;
            });
            var afterIndex = getChild(after, function(element) {
                var n = element.getAttribute("name");
                return (typeof n == "string") && n.indexOf(".newIndex") != -1;
            });
            var temp = beforeIndex.getAttribute("value");
            beforeIndex.setAttribute("value", afterIndex.getAttribute("value"));
            afterIndex.setAttribute("value", temp);
            after.parentNode.insertBefore(after, before);
        };
        /* This gets run whenever something in the <li> element gets clicked. This function is for <a> element buttons. */
        var liListener = function(event) {
            var target = event.target || event.srcElement || event.originalTarget;
            if(target.textContent == "Move Up") {
                event.preventDefault();
                if(this.previousElementSibling != null) {
                    swapElements(this.previousElementSibling, this);
                }
            }
            else if(target.textContent == "Move Down") {
                event.preventDefault();
                if(this.nextElementSibling != null) {
                    swapElements(this, this.nextElementSibling);
                }
            }
            else if(target.textContent == "Delete" || target.textContent == "Undo Delete") {
                event.preventDefault();
                var question_index = target.getAttribute("id").split(".")[0];
                toggleVisibility(question_index + ".deleteWarning", target, "Delete", "Undo Delete");
                var hiddenInput = document.getElementById(question_index + ".delete");
                if(hiddenInput.value == "delete") hiddenInput.value = "";
                else                              hiddenInput.value = "delete";
            }
        }
        for(var i = 0; i < listElements.length; i++) {
            listElements[i].addEventListener("click", liListener);
        }

        var changeType = function(question_index, type) {
            var minmax = "";
            document.getElementById(question_index+".answersDiv").classList.add("polyforms-hidden");
            if(type == "choice") {
                minmax = "selectable choices";
                document.getElementById(question_index+".answersDiv").classList.remove("polyforms-hidden");
            } else if(type == "int" || type == "number") {
                minmax = "value";
            } else {
                minmax = "answer length";
            }
            document.getElementById(question_index+".min").previousElementSibling.textContent = "Minimum " + minmax;
            document.getElementById(question_index+".max").previousElementSibling.textContent = "Maximum " + minmax;
        };

        document.getElementById("add").addEventListener("click", function(event) {
            event.preventDefault();
            var li = document.createElement("li");
            var ol = document.getElementsByTagName("ol")[0];
            li.innerHTML = '<div class="card mb-5">\n    <div class="card-header">\n        <a class="card-link" href="">Move Up</a>\n        <a class="card-link" href="">Move Down</a>\n        <a class="card-link" href="" id="INDEX.deleteButton">Delete</a>\n        <p class="card-text text-danger d-none" id="INDEX.deleteWarning">This question and its responses will be permanently deleted when you save.</p>\n    </div>\n    <div class="card-body">\n        <div class="form-group row">\n            <label for="INDEX.question" class="polyforms-label col-12 col-sm-2 col-form-label">Question: </label>\n            <div class="col"><input id="INDEX.question" name="INDEX.question" type="text" value="" class="form-control" required></div>\n        </div>\n        <div class="row">\n            <div class="form-group col-12 col-sm-6">\n                <label for="INDEX.type" class="polyforms-label">Question Type: </label>\n                <select id="INDEX.type" name="INDEX.type" class="form-control" onchange="changeType(INDEX, this.value);">\n                    <option value="short" selected>one-line response</option>\n                    <option value="long">extended response</option>\n                    <option value="int">integer</option>\n                    <option value="number">number</option>\n                    <option value="choice">multiple-choice</option>\n                </select>\n            </div>\n            <div class="form-group col">\n                <label for="INDEX.required">Required:</label>\n                <input id="INDEX.required" name="INDEX.required" type="checkbox">\n            </div>\n        </div>\n        <div class="form-group row">\n            <div class="col"><label for="INDEX.min">Minimum characters</label><input id="INDEX.min" name="INDEX.min" type="number" min="0" value="" class="form-control" placeholder="number"></div>\n            <div class="col"><label for="INDEX.max">Maximum characters</label><input id="INDEX.max" name="INDEX.max" type="number" min="0" value="" class="form-control" placeholder="number"></div>\n        </div>\n        <div class="form-group polyforms-hidden" id="INDEX.answersDiv">\n            <label for="INDEX.answers">Enter answer choices in the following box, where each answer choice is on a new line.</label>\n            <textarea name="INDEX.answers" id="INDEX.answers" class="form-control" rows="4" required>.</textarea>\n        </div>\n        <input type="hidden" name="INDEX.newIndex" value="INDEX">\n        <input type="hidden" name="INDEX.delete" id="INDEX.delete" value="">\n    </div>\n</div>'.replace(/INDEX/g, ol.children.length + 1);
            li.addEventListener("click", liListener);
            ol.appendChild(li);
        });
    </script>
{% endblock %}
